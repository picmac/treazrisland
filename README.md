# TREAZRISLAND

TREAZRISLAND is a self-hosted retro gaming portal that blends a Fastify backend, a Next.js 19 frontend, and SNES-inspired artwork. This repository also contains documentation and infrastructure helpers required to run the stack locally or on a home server.

## Architecture overview

| Layer      | Location          | Summary |
| ---------- | ----------------- | ------- |
| Backend    | `backend/`        | Fastify + Prisma service providing authentication, library management, ROM delivery, and save-state APIs. |
| Frontend   | `frontend/`       | Next.js App Router experience that consumes the backend APIs and renders EmulatorJS locally. |
| Infra      | `infra/`          | Docker Compose definitions and deployment scripts for local and production-like hosting. |
| Docs       | `docs/`           | Product, security, testing, and operations guides referenced throughout the codebase. |

Review the [Product Requirements Document](./TREAZRISLAND_PRD.md) and the [Threat Model](./docs/security/threat-model.md) before making changes that affect behaviour or security posture.

## Prerequisites

- Node.js 20 LTS and npm 10 (matching the versions generated by the checked-in lockfiles).
- Docker and Docker Compose v2 for containerised dependencies.
- Git LFS if you plan to version large binary assets.

## Environment configuration

1. Copy the template and keep it as the canonical source of truth for local values:

   ```bash
   cp .env.example .env
   ```

2. Reuse the same file everywhere by symlinking it into each package (or copying it if you prefer standalone files):

   ```bash
   ln -s ../.env backend/.env
   ln -s ../.env frontend/.env.local
   ```

   The frontend reads only `NEXT_PUBLIC_*` variables; adjust `NEXT_PUBLIC_API_BASE_URL` if your backend runs on a non-default
   host/port. `NEXT_PUBLIC_API_BASE_URL` and `STORAGE_ENDPOINT` default to `http://localhost` so the stack works without TLS in
   development.

3. Replace all placeholder secrets before exposing the stack to real users. The most important keys are summarised below:

| Area | Keys | Notes |
| ---- | ---- | ----- |
| JWT & sessions | `JWT_SECRET`, `JWT_ACCESS_TTL`, `JWT_REFRESH_TTL` | Use a 32+ character secret in production. TTL values accept [zeit/ms](https://github.com/vercel/ms) format (`15m`, `30d`). |
| Email (Postmark) | `POSTMARK_SERVER_TOKEN`, `POSTMARK_FROM_EMAIL`, `POSTMARK_MESSAGE_STREAM` | Mandatory when `EMAIL_PROVIDER=postmark`. Disable email features by leaving the provider unset only in development. |
| Storage | `STORAGE_DRIVER`, `STORAGE_*` | Set `STORAGE_DRIVER=filesystem` for a simple local path (`STORAGE_LOCAL_ROOT`). For MinIO/S3, fill `ENDPOINT`, `REGION`, `ACCESS_KEY`, `SECRET_KEY`, and bucket names. |
| ScreenScraper | `SCREENSCRAPER_*` | Store plaintext credentials in a secret manager. Use `npm run screenscraper:encrypt` (in `backend/`) to produce the encrypted developer ID/password and commit only the encrypted values. |
| Observability | `LOG_LEVEL`, `METRICS_ENABLED`, `METRICS_TOKEN` | Enable metrics and set a token when scraping `/metrics` from Prometheus. |
| Frontend security | `TREAZ_TLS_MODE` | Leave as `http` locally. Switch to `https` to emit HSTS/`upgrade-insecure-requests` once a reverse proxy terminates TLS. |

Backend configuration is validated on boot by [`backend/src/config/env.ts`](./backend/src/config/env.ts). The process exits with a detailed error message if any required key is missing or malformed.

### HTTP defaults and opting into TLS

- The repository ships with `TREAZ_TLS_MODE=http`, which tells the Next.js security middleware to skip HSTS and `upgrade-insecure-requests` so browsers happily talk to `http://localhost` during development.
- When you're ready to front the stack with TLS, switch `TREAZ_TLS_MODE=https` and update the public URLs:
  - Point `NEXT_PUBLIC_API_BASE_URL` and `CORS_ALLOWED_ORIGINS` at your `https://` hostname.
  - Update `STORAGE_ENDPOINT` to an HTTPS object-store endpoint (or unset it if your S3-compatible provider enforces TLS automatically).
  - Restart the frontend dev server or rebuild the production bundle so the new security headers take effect.
- Keep the backend and frontend `.env` files in sync (symlinks or shared `TREAZ_ENV_FILE`) so these values propagate through Docker Compose and helper scripts.

## Local development workflow

You can launch both apps with the HTTP defaults in a single terminal via:

```bash
./scripts/dev-http.sh
```

The helper loads `.env.http` (or `.env`) and starts the backend on `http://localhost:3001` and the frontend on
`http://localhost:3000`, printing the URLs for quick access.

1. **Start shared services**

   ```bash
   docker compose -f infra/docker-compose.yml up postgres minio
   ```

   The compose file also defines `backend` and `frontend` services; omit them when you want to run the apps directly on your host.

2. **Install backend dependencies and apply database state**

   ```bash
   cd backend
   npm install
   npx prisma migrate deploy
   npm run prisma:seed:platforms
   npm run dev
   ```

   The dev server listens on `http://localhost:3001` by default. Keep this terminal open so Fastify can hot-reload on changes.

3. **Install frontend dependencies and start the Next.js dev server**

   ```bash
   cd frontend
   npm install
   npm run dev
   ```

   Visit `http://localhost:3000` to access the App Router UI. Authentication flows call the backend using the base URL defined in `NEXT_PUBLIC_API_BASE_URL`.

4. **Optional: run everything via Docker Compose**

   ```bash
   docker compose -f infra/docker-compose.yml up --build
   ```

   This command builds the Dockerfiles, loads environment defaults from `.env` (or the file referenced by `TREAZ_ENV_FILE`), and
   launches all services together.

## Quality gates

Follow the [Testing Strategy](./docs/testing/README.md) before opening a pull request. In brief:

- `npm run lint` and `npm test` in both `backend/` and `frontend/`.
- `npm run build` in each package to ensure production bundles compile.
- Optional Playwright smoke tests: `RUN_SMOKE_E2E=1 npm run test:e2e:smoke` from `frontend/` after the stack is running.

## Additional references

- [Infrastructure guide](./infra/README.md)
- [Observability guide](./docs/observability/README.md)
- [Security documentation](./docs/security/README.md)
- [QA baseline gallery](./docs/qa/README.md)

Use the documentation map above to deep-dive into specific features, integrations, or operational procedures.
