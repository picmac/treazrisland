# ROM Import Runbook

This runbook explains how to register ROMs with the Treazrisland backend by
dropping manifest files into `./data/import` and executing the
`scripts/roms/import_from_folder.ts` helper.

## Prerequisites

1. Backend server reachable from your machine (default: `http://localhost:3000`).
2. Object storage credentials configured in the backend so uploads generated by
   the API succeed.
3. Node.js 20.x with `pnpm install` completed (the script is written in TypeScript
   and can be executed with `pnpm ts-node`).
4. If the backend requires authentication, have a bearer token ready and export it
   as `ROM_IMPORT_API_TOKEN` before running the script.

## Directory Layout

```
./data/import/
  example-rom.json       # manifest file (one per ROM)
  example-rom.nes        # referenced ROM asset
  processed/             # populated automatically after successful imports
```

The script automatically creates both `data/import` and
`data/import/processed` if they do not exist.

## Manifest Format

Create one JSON manifest per ROM and place it next to the binary asset.

```json
{
  "title": "Example Adventure",
  "description": "Demo ROM",
  "platformId": "gba",
  "releaseYear": 2001,
  "genres": ["adventure"],
  "asset": {
    "filename": "example-rom.gba",
    "contentType": "application/octet-stream",
    "checksum": "<sha256 of the file>"
  }
}
```

* `filename` is resolved relative to `data/import`.
* `contentType` must match what the backend expects for the given ROM.
* `checksum` must be the lowercase SHA-256 hex digest of the ROM file. The script
  recomputes the checksum before sending data to the API and fails the import if
  it does not match the manifest.

## Running the Importer

From the repository root:

```bash
ROM_IMPORT_API_URL="http://localhost:3000" \
ROM_IMPORT_API_TOKEN="<optional JWT>" \
pnpm ts-node scripts/roms/import_from_folder.ts
```

* `ROM_IMPORT_API_URL` defaults to `http://localhost:3000`. Override it if the
  backend lives elsewhere.
* `ROM_IMPORT_API_TOKEN` is optional. When set, the script sends it as a Bearer
  token.

The script scans `data/import` for `*.json` files, validates each manifest, and
POSTs a payload identical to `/admin/roms` to the backend. Successful runs move
both the manifest and its ROM binary into `data/import/processed/<manifest>-<timestamp>/`.

## Handling Failures

* If the checksum check fails, the script logs the mismatch and leaves the files
  in place so you can fix the manifest.
* API errors (HTTP 4xx/5xx) are logged with the upstream response body. No files
  are moved in this case.
* The script prints a summary when it finishes so you can confirm how many ROMs
  were processed.
