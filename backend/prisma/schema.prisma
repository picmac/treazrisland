generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

enum EnrichmentProvider {
  SCREEN_SCRAPER
  MANUAL
}

enum EnrichmentStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
}

enum RomBinaryStatus {
  PENDING
  READY
  FAILED
}

enum RomUploadStatus {
  PROCESSING
  SUCCEEDED
  FAILED
}

enum RomUploadKind {
  ROM
  BIOS
}

enum RomPlaybackAction {
  ROM_DOWNLOAD
  ASSET_DOWNLOAD
  PLAY_STATE_DOWNLOAD
  PLAY_STATE_UPLOAD
}

enum RomAssetType {
  COVER
  LOGO
  SCREENSHOT
  VIDEO
  MANUAL
  WHEEL
  MARQUEE
  MAP
  OTHER
}

enum RomAssetSource {
  SCREEN_SCRAPER
  USER_UPLOAD
  MANUAL_ENTRY
}

model User {
  id             String               @id @default(cuid())
  email          String               @unique
  nickname       String               @unique
  displayName    String?
  passwordHash   String
  role           Role                 @default(USER)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  avatarStorageKey String?
  avatarMimeType String?
  avatarFileSize Int?
  avatarUpdatedAt DateTime?
  refreshTokens  RefreshToken[]
  refreshTokenFamilies RefreshTokenFamily[]
  mfaSecrets     MfaSecret[]
  passwordResets PasswordResetToken[]
  createdInvites UserInvitation[]     @relation("AdminInvitations")
  enrichmentJobs RomEnrichmentJob[]
  screenScraperSettings ScreenScraperSettings[]
  romUploadAudits RomUploadAudit[]
  loginAudits    LoginAudit[]
  playStates     PlayState[]
  romPlaybackAudits RomPlaybackAudit[]
  favorites      UserRomFavorite[]
  createdCollections RomCollection[] @relation("CollectionCreators")
  createdTopLists    RomTopList[]    @relation("TopListCreators")
}

model UserInvitation {
  id          String   @id @default(cuid())
  tokenHash   String   @unique
  role        Role     @default(USER)
  email       String?
  expiresAt   DateTime
  redeemedAt  DateTime?
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy User? @relation("AdminInvitations", fields: [createdById], references: [id])
}

model RefreshTokenFamily {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime      @default(now())
  revokedAt     DateTime?
  revokedReason String?
  tokens        RefreshToken[]

  @@index([userId])
}

model RefreshToken {
  id            String   @id @default(cuid())
  tokenHash     String   @unique
  userId        String
  familyId      String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  family        RefreshTokenFamily @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  expiresAt     DateTime
  revokedAt     DateTime?
  revokedReason String?

  @@index([userId])
  @@index([familyId])
  @@index([expiresAt])
}

enum LoginAuditEvent {
  SUCCESS
  FAILURE
  MFA_REQUIRED
  LOGOUT
  PASSWORD_RESET
}

model LoginAudit {
  id             String          @id @default(cuid())
  userId         String?
  user           User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  emailAttempted String?
  ipAddress      String?
  userAgent      String?
  event          LoginAuditEvent
  reason         String?
  createdAt      DateTime        @default(now())

  @@index([userId])
  @@index([createdAt])
}

model PasswordResetToken {
  id         String   @id @default(cuid())
  tokenHash  String   @unique
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  redeemedAt DateTime?

  @@index([userId])
}

model MfaSecret {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  secret     String
  recoveryCodes String
  createdAt  DateTime @default(now())
  rotatedAt  DateTime?
  disabledAt DateTime?

  @@index([userId])
}

model Platform {
  id              String  @id @default(cuid())
  name            String
  slug            String  @unique
  shortName       String?
  screenscraperId Int?    @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  roms            Rom[]
  romUploadAudits RomUploadAudit[]
}

model Rom {
  id              String   @id @default(cuid())
  platformId      String
  platform        Platform @relation(fields: [platformId], references: [id])
  title           String
  romHash         String?
  romSize         Int?
  releaseYear     Int?
  players         Int?
  screenscraperId Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  metadata        RomMetadata[]
  assets          RomAsset[]
  enrichmentJobs  RomEnrichmentJob[]
  binary          RomBinary?
  uploadAudits    RomUploadAudit[]
  playStates      PlayState[]
  romPlaybackAudits RomPlaybackAudit[]
  favorites       UserRomFavorite[]
  collectionItems RomCollectionItem[]
  topListEntries  RomTopListEntry[]

  @@index([platformId])
  @@index([screenscraperId])
}

model RomMetadata {
  id          String   @id @default(cuid())
  romId       String
  rom         Rom      @relation(fields: [romId], references: [id], onDelete: Cascade)
  source      EnrichmentProvider
  language    String?
  region      String?
  summary     String?
  storyline   String?
  developer   String?
  publisher   String?
  genre       String?
  rating      Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([romId])
  @@unique([romId, source])
}

model RomAsset {
  id           String          @id @default(cuid())
  romId        String
  rom          Rom             @relation(fields: [romId], references: [id], onDelete: Cascade)
  type         RomAssetType
  source       RomAssetSource
  providerId   String?
  language     String?
  region       String?
  width        Int?
  height       Int?
  fileSize     Int?
  format       String?
  checksum     String?
  storageKey   String?
  externalUrl  String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  playbackAudits RomPlaybackAudit[]

  @@index([romId])
  @@index([type])
  @@index([providerId])
  @@unique([romId, providerId])
}

model RomBinary {
  id               String          @id @default(cuid())
  romId            String          @unique
  rom              Rom             @relation(fields: [romId], references: [id], onDelete: Cascade)
  storageKey       String
  originalFilename String
  archiveMimeType  String?
  archiveSize      Int
  checksumSha256   String
  checksumSha1     String?
  checksumMd5      String?
  checksumCrc32    String?
  status           RomBinaryStatus @default(READY)
  uploadedAt       DateTime        @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  uploadAudits     RomUploadAudit[]
  playbackAudits   RomPlaybackAudit[]
}

model EmulatorBios {
  id               String            @id @default(cuid())
  coreSlug         String
  region           String?
  description      String?
  originalFilename String
  storageKey       String
  archiveMimeType  String?
  archiveSize      Int
  checksumSha256   String
  checksumSha1     String?
  checksumMd5      String?
  checksumCrc32    String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  uploadAudits     RomUploadAudit[]

  @@unique([coreSlug, originalFilename])
  @@index([coreSlug])
}

model RomUploadAudit {
  id               String          @id @default(cuid())
  kind             RomUploadKind
  status           RomUploadStatus
  romId            String?
  rom              Rom?            @relation(fields: [romId], references: [id], onDelete: SetNull)
  romBinaryId      String?
  romBinary        RomBinary?      @relation(fields: [romBinaryId], references: [id], onDelete: SetNull)
  biosId           String?
  bios             EmulatorBios?   @relation(fields: [biosId], references: [id], onDelete: SetNull)
  platformId       String?
  platform         Platform?       @relation(fields: [platformId], references: [id], onDelete: SetNull)
  uploadedById     String?
  uploadedBy       User?           @relation(fields: [uploadedById], references: [id], onDelete: SetNull)
  storageKey       String
  originalFilename String
  archiveMimeType  String?
  archiveSize      Int?
  checksumSha256   String?
  checksumSha1     String?
  checksumMd5      String?
  checksumCrc32    String?
  errorMessage     String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([romId])
  @@index([romBinaryId])
  @@index([biosId])
  @@index([platformId])
  @@index([uploadedById])
}

model PlayState {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  romId          String
  rom            Rom      @relation(fields: [romId], references: [id], onDelete: Cascade)
  storageKey     String
  label          String?
  slot           Int?
  size           Int
  checksumSha256 String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  playbackAudits RomPlaybackAudit[]

  @@index([userId])
  @@index([romId])
  @@unique([userId, romId, slot], map: "play_state_unique_slot")
}

model RomPlaybackAudit {
  id             String             @id @default(cuid())
  userId         String?
  user           User?              @relation(fields: [userId], references: [id], onDelete: SetNull)
  romId          String?
  rom            Rom?               @relation(fields: [romId], references: [id], onDelete: SetNull)
  romBinaryId    String?
  romBinary      RomBinary?         @relation(fields: [romBinaryId], references: [id], onDelete: SetNull)
  romAssetId     String?
  romAsset       RomAsset?          @relation(fields: [romAssetId], references: [id], onDelete: SetNull)
  playStateId    String?
  playState      PlayState?         @relation(fields: [playStateId], references: [id], onDelete: SetNull)
  action         RomPlaybackAction
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime           @default(now())

  @@index([userId])
  @@index([romId])
  @@index([romBinaryId])
  @@index([romAssetId])
  @@index([playStateId])
  @@index([createdAt])
}

model UserRomFavorite {
  userId    String
  romId     String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  rom  Rom  @relation(fields: [romId], references: [id], onDelete: Cascade)

  @@id([userId, romId])
  @@index([romId])
}

model RomCollection {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  description String?
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?

  createdBy User? @relation("CollectionCreators", fields: [createdById], references: [id], onDelete: SetNull)
  items      RomCollectionItem[]

  @@index([isPublished])
}

model RomCollectionItem {
  id           String   @id @default(cuid())
  collectionId String
  romId        String
  position     Int
  note         String?
  createdAt    DateTime @default(now())

  collection RomCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  rom        Rom           @relation(fields: [romId], references: [id], onDelete: Cascade)

  @@unique([collectionId, romId])
  @@unique([collectionId, position])
  @@index([romId])
}

model RomTopList {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  description String?
  publishedAt DateTime?
  effectiveFrom DateTime?
  effectiveTo DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?

  createdBy User? @relation("TopListCreators", fields: [createdById], references: [id], onDelete: SetNull)
  entries   RomTopListEntry[]
}

model RomTopListEntry {
  id        String   @id @default(cuid())
  topListId String
  romId     String
  rank      Int
  blurb     String?
  createdAt DateTime @default(now())

  topList RomTopList @relation(fields: [topListId], references: [id], onDelete: Cascade)
  rom     Rom        @relation(fields: [romId], references: [id], onDelete: Cascade)

  @@unique([topListId, romId])
  @@unique([topListId, rank])
  @@index([romId])
}

model RomEnrichmentJob {
  id              String             @id @default(cuid())
  romId           String
  rom             Rom                @relation(fields: [romId], references: [id], onDelete: Cascade)
  requestedById   String?
  requestedBy     User?              @relation(fields: [requestedById], references: [id], onDelete: SetNull)
  status          EnrichmentStatus   @default(PENDING)
  provider        EnrichmentProvider
  providerRomId   String?
  settings        Json
  errorMessage    String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([romId])
  @@index([status])
}

model ScreenScraperSettings {
  id                 String   @id @default(cuid())
  userId             String?  @unique
  user               User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  languagePriority   String[] @default([])
  regionPriority     String[] @default([])
  mediaTypes         String[] @default([])
  onlyBetterMedia    Boolean  @default(false)
  maxAssetsPerType   Int      @default(3)
  preferParentGames  Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([userId])
}

model ScreenScraperCacheEntry {
  id        String   @id @default(cuid())
  cacheKey  String   @unique
  payload   Json
  expiresAt DateTime?
  createdAt DateTime @default(now())
}

