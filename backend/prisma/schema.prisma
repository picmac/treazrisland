generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

enum EnrichmentProvider {
  SCREEN_SCRAPER
  PIXELLAB
  MANUAL
}

enum EnrichmentStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
}

enum RomBinaryStatus {
  PENDING
  READY
  FAILED
}

enum RomUploadStatus {
  PROCESSING
  SUCCEEDED
  FAILED
}

enum RomUploadKind {
  ROM
  BIOS
}

enum NetplaySessionStatus {
  ACTIVE
  ENDED
  EXPIRED
}

enum NetplayParticipantRole {
  HOST
  GUEST
}

enum RomAssetType {
  COVER
  LOGO
  SCREENSHOT
  VIDEO
  MANUAL
  WHEEL
  MARQUEE
  MAP
  OTHER
}

enum RomAssetSource {
  SCREEN_SCRAPER
  PIXELLAB
  USER_UPLOAD
  MANUAL_ENTRY
}

model User {
  id             String               @id @default(cuid())
  email          String               @unique
  nickname       String               @unique
  displayName    String?
  passwordHash   String
  role           Role                 @default(USER)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  refreshTokens  RefreshToken[]
  mfaSecrets     MfaSecret[]
  passwordResets PasswordResetToken[]
  createdInvites UserInvitation[]     @relation("AdminInvitations")
  enrichmentJobs RomEnrichmentJob[]
  screenScraperSettings ScreenScraperSettings[]
  romUploadAudits RomUploadAudit[]
  hostedNetplaySessions NetplaySession[] @relation("NetplayHost")
  endedNetplaySessions NetplaySession[] @relation("NetplayEndedBy")
  netplayParticipants NetplayParticipant[]
}

model UserInvitation {
  id          String   @id @default(cuid())
  tokenHash   String   @unique
  role        Role     @default(USER)
  email       String?
  expiresAt   DateTime
  redeemedAt  DateTime?
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy User? @relation("AdminInvitations", fields: [createdById], references: [id])
}

model RefreshToken {
  id         String   @id @default(cuid())
  tokenHash  String   @unique
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  revokedAt  DateTime?

  @@index([userId])
  @@index([expiresAt])
}

model PasswordResetToken {
  id         String   @id @default(cuid())
  tokenHash  String   @unique
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  redeemedAt DateTime?

  @@index([userId])
}

model MfaSecret {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  secret     String
  recoveryCodes String
  createdAt  DateTime @default(now())
  rotatedAt  DateTime?
  disabledAt DateTime?

  @@index([userId])
}

model Platform {
  id              String  @id @default(cuid())
  name            String
  slug            String  @unique
  shortName       String?
  screenscraperId Int?    @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  roms            Rom[]
  romUploadAudits RomUploadAudit[]
}

model Rom {
  id              String   @id @default(cuid())
  platformId      String
  platform        Platform @relation(fields: [platformId], references: [id])
  title           String
  romHash         String?
  romSize         Int?
  releaseYear     Int?
  players         Int?
  screenscraperId Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  metadata        RomMetadata[]
  assets          RomAsset[]
  enrichmentJobs  RomEnrichmentJob[]
  binary          RomBinary?
  uploadAudits    RomUploadAudit[]
  netplaySessions NetplaySession[]

  @@index([platformId])
  @@index([screenscraperId])
}

model RomMetadata {
  id          String   @id @default(cuid())
  romId       String
  rom         Rom      @relation(fields: [romId], references: [id], onDelete: Cascade)
  source      EnrichmentProvider
  language    String?
  region      String?
  summary     String?
  storyline   String?
  developer   String?
  publisher   String?
  genre       String?
  rating      Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([romId])
  @@unique([romId, source])
}

model RomAsset {
  id           String          @id @default(cuid())
  romId        String
  rom          Rom             @relation(fields: [romId], references: [id], onDelete: Cascade)
  type         RomAssetType
  source       RomAssetSource
  providerId   String?
  language     String?
  region       String?
  width        Int?
  height       Int?
  fileSize     Int?
  format       String?
  checksum     String?
  storageKey   String?
  externalUrl  String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([romId])
  @@index([type])
  @@index([providerId])
  @@unique([romId, providerId])
}

model RomBinary {
  id               String          @id @default(cuid())
  romId            String          @unique
  rom              Rom             @relation(fields: [romId], references: [id], onDelete: Cascade)
  storageKey       String
  originalFilename String
  archiveMimeType  String?
  archiveSize      Int
  checksumSha256   String
  checksumSha1     String?
  checksumMd5      String?
  checksumCrc32    String?
  status           RomBinaryStatus @default(READY)
  uploadedAt       DateTime        @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  uploadAudits     RomUploadAudit[]
}

model EmulatorBios {
  id               String            @id @default(cuid())
  coreSlug         String
  region           String?
  description      String?
  originalFilename String
  storageKey       String
  archiveMimeType  String?
  archiveSize      Int
  checksumSha256   String
  checksumSha1     String?
  checksumMd5      String?
  checksumCrc32    String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  uploadAudits     RomUploadAudit[]

  @@unique([coreSlug, originalFilename])
  @@index([coreSlug])
}

model RomUploadAudit {
  id               String          @id @default(cuid())
  kind             RomUploadKind
  status           RomUploadStatus
  romId            String?
  rom              Rom?            @relation(fields: [romId], references: [id], onDelete: SetNull)
  romBinaryId      String?
  romBinary        RomBinary?      @relation(fields: [romBinaryId], references: [id], onDelete: SetNull)
  biosId           String?
  bios             EmulatorBios?   @relation(fields: [biosId], references: [id], onDelete: SetNull)
  platformId       String?
  platform         Platform?       @relation(fields: [platformId], references: [id], onDelete: SetNull)
  uploadedById     String?
  uploadedBy       User?           @relation(fields: [uploadedById], references: [id], onDelete: SetNull)
  storageKey       String
  originalFilename String
  archiveMimeType  String?
  archiveSize      Int?
  checksumSha256   String?
  checksumSha1     String?
  checksumMd5      String?
  checksumCrc32    String?
  errorMessage     String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([romId])
  @@index([romBinaryId])
  @@index([biosId])
  @@index([platformId])
  @@index([uploadedById])
}

model RomEnrichmentJob {
  id              String             @id @default(cuid())
  romId           String
  rom             Rom                @relation(fields: [romId], references: [id], onDelete: Cascade)
  requestedById   String?
  requestedBy     User?              @relation(fields: [requestedById], references: [id], onDelete: SetNull)
  status          EnrichmentStatus   @default(PENDING)
  provider        EnrichmentProvider
  providerRomId   String?
  settings        Json
  errorMessage    String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([romId])
  @@index([status])
}

model ScreenScraperSettings {
  id                 String   @id @default(cuid())
  userId             String?  @unique
  user               User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  languagePriority   String[] @default([])
  regionPriority     String[] @default([])
  mediaTypes         String[] @default([])
  onlyBetterMedia    Boolean  @default(false)
  maxAssetsPerType   Int      @default(3)
  preferParentGames  Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([userId])
}

model ScreenScraperCacheEntry {
  id        String   @id @default(cuid())
  cacheKey  String   @unique
  payload   Json
  expiresAt DateTime?
  createdAt DateTime @default(now())
}

model NetplaySession {
  id                String               @id @default(cuid())
  code              String               @unique
  hostUserId        String
  hostUser          User                 @relation("NetplayHost", fields: [hostUserId], references: [id], onDelete: Cascade)
  romId             String?
  rom               Rom?                 @relation(fields: [romId], references: [id], onDelete: SetNull)
  status            NetplaySessionStatus @default(ACTIVE)
  externalSessionId String?
  expiresAt         DateTime
  endedAt           DateTime?
  endedById         String?
  endedBy           User?                @relation("NetplayEndedBy", fields: [endedById], references: [id], onDelete: SetNull)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  participants      NetplayParticipant[]

  @@index([hostUserId])
  @@index([expiresAt])
  @@index([status])
}

model NetplayParticipant {
  id                    String                 @id @default(cuid())
  sessionId             String
  session               NetplaySession         @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId                String
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role                  NetplayParticipantRole @default(GUEST)
  externalParticipantId String?
  joinedAt              DateTime               @default(now())
  leftAt                DateTime?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
}
